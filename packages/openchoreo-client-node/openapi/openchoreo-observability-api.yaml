openapi: 3.0.3
info:
  title: OpenChoreo Observer API
  description: |
    The OpenChoreo Observer API provides endpoints for querying logs,
    traces, and metrics from namespaces for components, projects, and environments,
    as well as logs from workflows.
    It integrates with separate observability modules to fetch the actual data via
    API calls to the adaptors provided by the modules.
  version: 1.0.0
  contact:
    name: OpenChoreo Team
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

tags:
  - name: Logs
    description: Log retrieval endpoints
  - name: Health
    description: Health check endpoints

security:
  - BearerAuth: []

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check the health status of the observer service.
      operationId: health
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: unhealthy
                  error:
                    type: string
                    example: 'opensearch: connection failed'

  # Logs query endpoint
  /api/v1/logs/query:
    post:
      tags:
        - Logs
      summary: Query logs
      description: Query logs from the observer service
      operationId: queryLogs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogsQueryRequest'
      responses:
        '200':
          description: Logs queried successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogsQueryResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                title: 'badRequest'
                errorCode: ''
                message: "Missing required fields 'startTime' and 'endTime'"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                title: 'unauthorized'
                errorCode: ''
                message: 'Invalid or missing token'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                title: 'forbidden'
                errorCode: ''
                message: 'Subject <xyz> has no permission to view logs of Namespace foo, Project bar, Component baz in Environment development'
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                title: 'internalServerError'
                errorCode: 'OBS-V1-L-29'
                message: ''

  # TODO: Remove this in favor of /api/v1/logs/query
  /api/v1/namespaces/{namespaceName}/projects/{projectName}/components/{componentName}/workflow-runs/{runName}/logs:
    get:
      tags:
        - Logs
      summary: Get workflow run logs (stream)
      description: |
        Returns logs from a workflow run stored in the observability plane.
        This endpoint is used when logs are older than the TTL and have been archived to OpenSearch.
        Logs are returned as a JSON array of log entries with timestamps, optionally filtered by step.
      operationId: getComponentWorkflowRunLogs
      parameters:
        - name: namespaceName
          in: path
          required: true
          description: The namespace name
          schema:
            type: string
            example: 'reading-list-service-workflow-290506e5'
        - name: projectName
          in: path
          required: true
          description: The project name
          schema:
            type: string
            example: 'default'
        - name: componentName
          in: path
          required: true
          description: The component name
          schema:
            type: string
            example: 'reading-list-service'
        - name: runName
          in: path
          required: true
          description: The workflow run name
          schema:
            type: string
            example: 'reading-list-service-workflow-290506e5'
        - name: step
          in: query
          required: false
          description: Filter logs by a specific workflow step name
          schema:
            type: string
            example: build-step
      responses:
        '200':
          description: Successfully retrieved workflow run logs
          content:
            application/json:
              schema:
                type: array
                description: Array of log entries with timestamps
                items:
                  $ref: '#/components/schemas/ComponentWorkflowRunLogEntry'
              example:
                - timestamp: '2025-01-06T10:00:00.123Z'
                  log: 'Building application...'
                - timestamp: '2025-01-06T10:00:05.456Z'
                  log: 'Build completed successfully'
                - timestamp: '2025-01-06T10:00:10.789Z'
                  log: 'Pushing image to registry...'
                - timestamp: '2025-01-06T10:00:15.012Z'
                  log: 'Image pushed successfully'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Workflow run not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # TODO: Remove this as events support is not available in the observability plane yet
  /api/v1/namespaces/{namespaceName}/projects/{projectName}/components/{componentName}/workflow-runs/{runName}/events:
    get:
      tags:
        - Logs
      summary: Get workflow run events
      description: Retrieve events for a specific workflow run
      operationId: getWorkflowRunEvents
      parameters:
        - name: namespaceName
          in: path
          required: true
          description: The namespace name
          schema:
            type: string
            example: 'reading-list-service-workflow-290506e5'
        - name: projectName
          in: path
          required: true
          description: The project name
          schema:
            type: string
            example: 'default'
        - name: componentName
          in: path
          required: true
          description: The component name
          schema:
            type: string
            example: 'reading-list-service'
        - name: runName
          in: path
          required: true
          description: The workflow run name
          schema:
            type: string
            example: 'reading-list-service-workflow-290506e5'
        - name: step
          in: query
          required: false
          description: Filter events by a specific workflow step name
          schema:
            type: string
            example: build-step
      responses:
        '200':
          description: Successfully retrieved workflow run events
          content:
            application/json:
              schema:
                type: array
                description: Array of event entries with timestamps
                items:
                  $ref: '#/components/schemas/ComponentWorkflowRunEventEntry'
              example:
                - timestamp: '2025-01-06T10:00:00.123Z'
                  type: 'build-started'
                  reason: 'Build started'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Workflow run not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/traces:
    post:
      tags:
        - Traces
      summary: Get traces
      description: Retrieve distributed traces
      operationId: getTraces
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TracesRequest'
      responses:
        '200':
          description: Successfully retrieved component traces
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TraceResponse'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/metrics/component/http:
    post:
      tags:
        - Metrics
      summary: Get component HTTP metrics
      description: Retrieve HTTP request metrics (request counts, latency percentiles) for a component as time series data
      operationId: getComponentHTTPMetrics
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MetricsRequest'
      responses:
        '200':
          description: Successfully retrieved HTTP metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPMetricsTimeSeries'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/metrics/component/usage:
    post:
      tags:
        - Metrics
      summary: Get component resource metrics
      description: Retrieve resource usage metrics (CPU, memory) for a component as time series data
      operationId: getComponentResourceMetrics
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MetricsRequest'
      responses:
        '200':
          description: Successfully retrieved resource metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResourceMetricsTimeSeries'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    # Request schemas for logs
    ComponentSearchScope:
      type: object
      properties:
        namespace:
          type: string
        project:
          type: string
        component:
          type: string
        environment:
          type: string
      required: [namespace]

    WorkflowSearchScope:
      type: object
      properties:
        namespace:
          type: string
        workflowRunName:
          type: string
      required: [namespace]

    LogsQueryRequest:
      type: object
      properties:
        startTime:
          type: string
          description: The start time of the query
          format: date-time
        endTime:
          type: string
          description: The end time of the query
          format: date-time
        limit:
          type: integer
          default: 100
          minimum: 1
          maximum: 1000
          description: The maximum number of items to return
        sortOrder:
          type: string
          description: The sort order of the query
          enum:
            - asc
            - desc
          default: desc
        searchScope:
          oneOf:
            - $ref: '#/components/schemas/ComponentSearchScope'
            - $ref: '#/components/schemas/WorkflowSearchScope'
        logLevels:
          type: array
          uniqueItems: true
          items:
            type: string
            enum: ['DEBUG', 'INFO', 'WARN', 'ERROR']
        searchPhrase:
          type: string
      required: [startTime, endTime, searchScope]

    # Response schemas for logs
    ComponentLogEntry:
      type: object
      properties:
        timestamp:
          type: string
          description: The timestamp of the log entry
          format: date-time
        log:
          type: string
          description: The log message
        level:
          type: string
          description: The log level
        metadata:
          type: object
          description: The metadata of the log entry
          properties:
            componentName:
              type: string
              description: The OpenChoreo component name that generated the log
            projectName:
              type: string
              description: The OpenChoreo project name that generated the log
            environmentName:
              type: string
              description: The OpenChoreo environment name that generated the log
            namespaceName:
              type: string
              description: The OpenChoreo namespace name that generated the log
            componentUid:
              type: string
              description: The OpenChoreo component UID that generated the log
              format: uuid
            projectUid:
              type: string
              description: The OpenChoreo project UID that generated the log
              format: uuid
            environmentUid:
              type: string
              description: The OpenChoreo environment UID that generated the log
              format: uuid
            containerName:
              type: string
              description: The container name that generated the log
            podName:
              type: string
              description: The Kubernetes pod name that generated the log
            podNamespace:
              type: string
              description: The namespace of the Kubernetes pod that generated the log

    WorkflowLogEntry:
      type: object
      properties:
        timestamp:
          type: string
          description: The timestamp of the log entry
          format: date-time
        log:
          type: string
          description: The log message
        metadata:
          type: object
          description: The metadata of the log entry

    LogsQueryResponse:
      type: object
      properties:
        logs:
          oneOf:
            - type: array
              items:
                $ref: '#/components/schemas/ComponentLogEntry'
            - type: array
              items:
                $ref: '#/components/schemas/WorkflowLogEntry'
          description: The logs queried successfully
        total:
          type: integer
          description: The total number of logs queried
        tookMs:
          type: integer
          description: The time taken to query the logs in milliseconds

    TracesRequest:
      type: object
      required:
        - projectUid
        - startTime
        - endTime
        - componentNames
        - projectName
        - namespaceName
        - environmentName
      properties:
        projectUid:
          type: string
          format: uuid
          description: Project UID (required)
          example: '1c4e7a9b-3f6d-4e2a-8b5c-7d9f1e3a4c6b'
        componentUids:
          type: array
          items:
            type: string
            format: uuid
          description: Array of component UIDs to filter traces (optional)
          example:
            [
              '8a4c5e2f-9d3b-4a7e-b1f6-2c8d4e9f3a7b',
              '3f7b9e1a-4c6d-4e8f-a2b5-7d1c3e8f4a9b',
            ]
        environmentUid:
          type: string
          format: uuid
          description: Environment UID to filter traces (optional)
          example: '2f5a8c1e-7d9b-4e3f-6a4c-8e1f2d7a9b5c'
        traceId:
          type: string
          description: |
            Trace ID to filter by (optional). Supports wildcard characters:
            - `*` matches zero or more characters
            - `?` matches exactly one character

            Examples:
            - Exact match: `63d7c3065ab25375e6c5d6bb135a77db`
            - Prefix match: `63d7c3065ab2537*`
            - Suffix match: `*135a77db`
            - Single char wildcard: `63d7c3065ab2537?e6c5d6bb135a77db`
          pattern: '^[a-fA-F0-9*?]+$'
          example: '63d7c3065ab25375*'
        startTime:
          type: string
          format: date-time
          description: Start time for trace query in RFC3339 format (required)
          example: '2025-01-10T00:00:00Z'
        endTime:
          type: string
          format: date-time
          description: End time for trace query in RFC3339 format (required)
          example: '2025-01-10T23:59:59Z'
        limit:
          type: integer
          description: Maximum number of traces to return
          default: 100
          minimum: 1
          maximum: 10000
          example: 100
        sortOrder:
          type: string
          description: Sort order for traces
          enum: [asc, desc]
          default: desc
          example: 'desc'
        componentNames:
          type: array
          items:
            type: string
          description: Component names to filter traces
          example: ['my-component', 'my-component-2']
        projectName:
          type: string
          description: Project name
          example: 'my-project'
        environmentName:
          type: string
          description: Environment name
          example: 'my-environment'
        namespaceName:
          type: string
          description: Namespace name
          example: 'my-namespace'

    MetricsRequest:
      type: object
      required:
        - componentId
        - environmentId
        - projectId
        - componentName
        - projectName
        - namespaceName
        - environmentName
      properties:
        componentId:
          type: string
          description: Component identifier
          example: 'comp-123'
        environmentId:
          type: string
          description: Environment identifier
          example: 'env-dev'
        projectId:
          type: string
          description: Project identifier
          example: 'proj-456'
        startTime:
          type: string
          format: date-time
          description: Start time for metrics query in RFC3339 format
          example: '2025-01-10T00:00:00Z'
        endTime:
          type: string
          format: date-time
          description: End time for metrics query in RFC3339 format
          example: '2025-01-10T23:59:59Z'
        componentName:
          type: string
          description: Component name
          example: 'my-component'
        projectName:
          type: string
          description: Project name
          example: 'my-project'
        environmentName:
          type: string
          description: Environment name
          example: 'my-environment'
        namespaceName:
          type: string
          description: Namespace name
          example: 'my-namespace'

    TraceResponse:
      type: object
      properties:
        traces:
          type: array
          items:
            $ref: '#/components/schemas/Trace'
          description: Array of traces with their spans
        tookMs:
          type: integer
          description: Query execution time in milliseconds
          example: 15
      example:
        traces:
          - traceId: 'f3a7b9e1c4d2f5a8b6e3c9f1d4a7e2b8'
            spans:
              - spanId: 'ad3537e3f48207d0'
                name: 'lets-go'
                durationNanoseconds: 12300000
                startTime: '2025-12-03T09:16:56.84456548Z'
                endTime: '2025-12-03T09:16:56.84468848Z'
                parentSpanId: ''
                openchoreoComponentUid: '8a4c5e2f-9d3b-4a7e-b1f6-2c8d4e9f3a7b'
                openchoreoProjectUid: '1c4e7a9b-3f6d-4e2a-8b5c-7d9f1e3a4c6b'
        tookMs: 15

    Trace:
      type: object
      properties:
        traceId:
          type: string
          description: Unique trace identifier (32 hexadecimal characters)
          pattern: '^[a-fA-F0-9]{32}$'
          example: 'f3a7b9e1c4d2f5a8b6e3c9f1d4a7e2b8'
        spans:
          type: array
          items:
            $ref: '#/components/schemas/Span'
          description: Array of spans belonging to this trace

    Span:
      type: object
      properties:
        spanId:
          type: string
          description: Unique span identifier (16 hex characters)
          pattern: '^[a-f0-9]{16}$'
          example: 'ad3537e3f48207d0'
        name:
          type: string
          description: Span name/operation
          example: 'database-query'
        durationNanoseconds:
          type: integer
          format: int64
          description: Span duration in nanoseconds (calculated from endTime - startTime)
          example: 101018208
        startTime:
          type: string
          format: date-time
          description: Span start time in RFC3339Nano format
          example: '2025-10-28T11:13:56.484388Z'
        endTime:
          type: string
          format: date-time
          description: Span end time in RFC3339Nano format
          example: '2025-10-28T11:13:56.585406208Z'
        parentSpanId:
          type: string
          description: Parent span identifier (empty if root span)
          pattern: '^[a-f0-9]{0,16}$'
          example: 'b72e731db5edfd1d'
        openchoreoComponentUid:
          type: string
          format: uuid
          description: OpenChoreo component UID from resource attributes
          example: '8a4c5e2f-9d3b-4a7e-b1f6-2c8d4e9f3a7b'
        openchoreoProjectUid:
          type: string
          format: uuid
          description: OpenChoreo project UID from resource attributes
          example: '1c4e7a9b-3f6d-4e2a-8b5c-7d9f1e3a4c6b'

    TimeValuePoint:
      type: object
      properties:
        time:
          type: string
          format: date-time
          description: Timestamp in ISO 8601 format
          example: '2025-01-10T12:00:00Z'
        value:
          type: number
          format: double
          description: Metric value at this timestamp
          example: 0.75

    ResourceMetricsTimeSeries:
      type: object
      properties:
        cpuUsage:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: CPU usage time series (in cores)
        cpuRequests:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: CPU requests time series (in cores)
        cpuLimits:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: CPU limits time series (in cores)
        memory:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: Memory usage time series (in bytes)
        memoryRequests:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: Memory requests time series (in bytes)
        memoryLimits:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: Memory limits time series (in bytes)
      example:
        cpuUsage:
          - time: '2025-01-10T12:00:00Z'
            value: 0.25
          - time: '2025-01-10T12:05:00Z'
            value: 0.30
        cpuRequests:
          - time: '2025-01-10T12:00:00Z'
            value: 0.5
          - time: '2025-01-10T12:05:00Z'
            value: 0.5
        cpuLimits:
          - time: '2025-01-10T12:00:00Z'
            value: 1.0
          - time: '2025-01-10T12:05:00Z'
            value: 1.0
        memory:
          - time: '2025-01-10T12:00:00Z'
            value: 536870912
          - time: '2025-01-10T12:05:00Z'
            value: 549453824
        memoryRequests:
          - time: '2025-01-10T12:00:00Z'
            value: 1073741824
          - time: '2025-01-10T12:05:00Z'
            value: 1073741824
        memoryLimits:
          - time: '2025-01-10T12:00:00Z'
            value: 2147483648
          - time: '2025-01-10T12:05:00Z'
            value: 2147483648

    HTTPMetricsTimeSeries:
      type: object
      properties:
        requestCount:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: Total HTTP request count time series (requests per second)
        successfulRequestCount:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: Successful HTTP request count time series (status 200, requests per second)
        unsuccessfulRequestCount:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: Unsuccessful HTTP request count time series (status != 200, requests per second)
        meanLatency:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: Mean HTTP request latency time series (in seconds)
        latencyPercentile50th:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: 50th percentile (median) HTTP request latency time series (in seconds)
        latencyPercentile90th:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: 90th percentile HTTP request latency time series (in seconds)
        latencyPercentile99th:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: 99th percentile HTTP request latency time series (in seconds)
      example:
        requestCount:
          - time: '2025-01-10T12:00:00Z'
            value: 125.5
          - time: '2025-01-10T12:05:00Z'
            value: 143.2
        successfulRequestCount:
          - time: '2025-01-10T12:00:00Z'
            value: 120.0
          - time: '2025-01-10T12:05:00Z'
            value: 138.5
        unsuccessfulRequestCount:
          - time: '2025-01-10T12:00:00Z'
            value: 5.5
          - time: '2025-01-10T12:05:00Z'
            value: 4.7
        meanLatency:
          - time: '2025-01-10T12:00:00Z'
            value: 0.125
          - time: '2025-01-10T12:05:00Z'
            value: 0.132
        latencyPercentile50th:
          - time: '2025-01-10T12:00:00Z'
            value: 0.095
          - time: '2025-01-10T12:05:00Z'
            value: 0.102
        latencyPercentile90th:
          - time: '2025-01-10T12:00:00Z'
            value: 0.250
          - time: '2025-01-10T12:05:00Z'
            value: 0.265
        latencyPercentile99th:
          - time: '2025-01-10T12:00:00Z'
            value: 0.500
          - time: '2025-01-10T12:05:00Z'
            value: 0.520

    ErrorResponse:
      type: object
      required:
        - error
        - code
        - message
      properties:
        error:
          type: string
          description: Error type
          enum:
            - missingParameter
            - invalidRequest
            - internalError
          example: 'invalidRequest'
        code:
          type: string
          description: Error code
          example: 'OBS-L-12'
        message:
          type: string
          description: Human-readable error message
          example: 'Invalid request format'

    ComponentWorkflowRunLogEntry:
      type: object
      description: A single log entry from a component workflow run
      required:
        - log
      properties:
        timestamp:
          type: string
          format: date-time
          description: Timestamp when the log entry was generated (RFC3339 format)
          example: '2025-01-06T10:00:00.123Z'
        log:
          type: string
          description: The log message content
          example: 'Building application...'

    ComponentWorkflowRunEventEntry:
      type: object
      description: A single event entry from a component workflow run
      required:
        - timestamp
        - type
        - reason
        - message
      properties:
        timestamp:
          type: string
          format: date-time
          description: Timestamp when the event entry was generated (RFC3339 format)
          example: '2025-01-06T10:00:00.123Z'
        type:
          type: string
          description: Event type
          example: 'build-started'
        reason:
          type: string
          description: Reason for the event
          example: 'Build started'
        message:
          type: string
          description: Event message
          example: 'Build started...'
